<div class="container">
    {{#events:i}}
        {{#if current_event == i}}
            <div class="event" style="{{show_description ? 'margin-top: -75.5px' : ''}} background-image: url(images/{{_id.$oid}}-cover.png)">
                <div class="headline">
                    <h4>
                        {{#if start > get_date()}}
                            <span style="color: green">Upcoming: </span>
                        {{elseif start < get_date() && get_date() < end}}
                            <span style="color: yellow">Ongoing: </span>
                        {{else}}
                            <span style="color: red">Past: </span>
                        {{/if}}
                        {{name}}
                    </h4>
                    <small>{{start}}</small>
                    <p>{{headline}}</p>

                    {{#if !show_description}}
                        <button class="pure-button button-small" on-click="toggle('show_description')">Moreâ€¦</button>
                    {{/if}}
                </div>
            </div>

            {{#if show_description}}
                <div class="description">
                    <button class="pure-button button-close" on-click="toggle('show_description')">X</button>

                    {{{render_markdown(description)}}}
                </div>
            {{/if}}
        {{/if}}
    {{/events}}

    {{#if !show_description}}
        <div class="nav">
            <span on-click="rotate_event(-1)"> &lt; </span>
            &emsp;
            <span on-click="rotate_event(1)"> &gt; </span>
        </div>
    {{/if}}
</div>



<style>
    .container {
        width: 100vw;
        min-height: 200px;
        color: white;
    }
    .event {
        background-color: #210;
        display: inline-block;
        width: 100%;
        transition: 0.5s margin-top ease-out;
    }
    .headline {
        width: 400px;
        margin: 20px;
        padding: 10px;
        border: 1px solid white;
        border-radius: 8px;
    }
    .button-small {
        font-size: 80%;
    }
    .button-close {
        padding: 2px;
    }
    .nav {
        margin-top: -1.5em;
        font-weight: bolder;
        user-select: none;
        cursor: pointer;
        width: 100%;
        text-align: right;
    }
    .description {
        background-color: #210;
        opacity: 0.9;
        border: 2px solid white;
        border-radius: 8px;
        margin: 10px;
        padding: 10px;
        padding: 10px;
        background: #eee;
        color: black;
    }
</style>



<script>
    component.exports = {
        data: {
            events: [],
            current_event: 0,
            show_description: false,

            get_date: function() {
                return new Date()
            },
            render_markdown: function(text) {
                return markdown.toHTML(text)
            }
        },

        oninit: function() {
            var that = this;

            superagent.get("/events")
            .end( function( error, response ) {
                if (!error) {
                    var events = JSON.parse(response.text);

                    events.forEach( function(element) {
                        element.start = new Date( element.start['$date'] )
                        element.end = new Date( element.end['$date'] )
                    });
                    events.sort( function(a,b) {
                        var now = new Date()

                        if ( b.start < now && b.end > now ) {
                            return 1;
                        }
                        if ( a.start > b.start ) {
                            return -1;
                        }
                        else if ( a.start < b.start ) {
                            return 1;
                        }
                        else {
                            return 0;
                        }
                    })
                    that.set( 'events', events );
                }
            });
        },

        rotate_event: function(amount) {
            var current_event = ( this.get('current_event') + amount ) % 5
            if ( current_event < 0 ) {
                current_event = 5;
            }
            this.set( 'current_event', current_event )

        },

        transitions: {
            carousel: function(t) {
                if ( t.isIntro ) {
                    t.setStyle({ "transform": "translateX(100%)" });
                    t.animateStyle({ "transform": "translateX(0%)" }, {'duration': 500}, function() { t.complete() });
                }
                else {
                    t.animateStyle({ "transform": "translateX(-100%)" }, {'duration': 500}, function() { t.complete() });
                }
            }
        }
    }
</script>
